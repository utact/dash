<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.dash.board.infrastructure.mapper.BoardMapper">

  <insert id="insert" parameterType="Board" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO boards (title, content, user_id, algorithm_record_id, board_type, like_count, created_at, updated_at)
    VALUES (#{title}, #{content}, #{userId}, #{algorithmRecordId}, #{boardType}, #{likeCount}, #{createdAt}, #{updatedAt})
  </insert>

  <select id="selectById" resultType="Board" parameterType="long">
    SELECT 
      b.id, b.title, b.content, b.user_id, b.algorithm_record_id, b.board_type, b.like_count, 
      b.created_at, b.updated_at,
      u.username as author_name,
      u.role as author_role,
      d.css_class as author_decoration_class,
      (SELECT COUNT(*) FROM comments c WHERE c.board_id = b.id) as comment_count
    FROM boards b
    LEFT JOIN users u ON b.user_id = u.id
    LEFT JOIN decorations d ON u.equipped_decoration_id = d.id
    WHERE b.id = #{id}
  </select>

  <select id="selectByAlgorithmRecordId" resultType="Board" parameterType="long">
    SELECT 
      b.id, b.title, b.content, b.user_id, b.algorithm_record_id, b.board_type, b.like_count, 
      b.created_at, b.updated_at,
      u.username as author_name,
      u.role as author_role,
      d.css_class as author_decoration_class,
      (SELECT COUNT(*) FROM comments c WHERE c.board_id = b.id) as comment_count
    FROM boards b
    LEFT JOIN users u ON b.user_id = u.id
    LEFT JOIN decorations d ON u.equipped_decoration_id = d.id
    WHERE b.algorithm_record_id = #{recordId}
    LIMIT 1
  </select>

  <select id="selectAll" resultType="Board">
    SELECT 
      b.id, b.title, b.content, b.user_id, b.algorithm_record_id, b.board_type, b.like_count, 
      b.created_at, b.updated_at,
      u.username as author_name,
      u.role as author_role,
      d.css_class as author_decoration_class,
      (SELECT COUNT(*) FROM comments c WHERE c.board_id = b.id) as comment_count
    FROM boards b
    LEFT JOIN users u ON b.user_id = u.id
    LEFT JOIN decorations d ON u.equipped_decoration_id = d.id
    ORDER BY b.id DESC
  </select>

  <update id="update" parameterType="Board">
    UPDATE boards 
    SET title = #{title}, 
        content = #{content}, 
        algorithm_record_id = #{algorithmRecordId},
        like_count = #{likeCount},
        updated_at = #{updatedAt} 
    WHERE id = #{id}
  </update>

  <update id="updateLikeCount" parameterType="Board">
    UPDATE boards SET like_count = #{likeCount} WHERE id = #{id}
  </update>

  <delete id="delete" parameterType="long">
    DELETE FROM boards WHERE id = #{id}
  </delete>

</mapper>

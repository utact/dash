<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.dash.user.infrastructure.mapper.UserMapper">

  <insert id="insert" parameterType="User" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO users (username, email, role, status, created_at, provider, provider_id, avatar_url)
    VALUES (#{username}, #{email}, #{role}, #{status}, #{createdAt}, #{provider}, #{providerId}, #{avatarUrl})
  </insert>

  <select id="selectById" resultType="User" parameterType="long">
    SELECT * FROM users WHERE id = #{id} AND deleted_at IS NULL
  </select>

  <select id="selectAll" resultType="User">
    SELECT * FROM users WHERE deleted_at IS NULL ORDER BY id
  </select>

  <select id="selectByProviderAndProviderId" resultType="User">
    SELECT * FROM users 
    WHERE provider = #{provider} AND provider_id = #{providerId}
  </select>

  <update id="update" parameterType="User">
    UPDATE users
    SET username = #{username}, email = #{email}, role = #{role}, status = #{status}, provider = #{provider}, 
        provider_id = #{providerId}, avatar_url = #{avatarUrl}, study_id = #{studyId},
        solvedac_handle = #{solvedacHandle}, solvedac_tier = #{solvedacTier},
        solvedac_rating = #{solvedacRating}, solvedac_class = #{solvedacClass},
        solved_count = #{solvedCount},
        stats_last_synced_at = #{statsLastSyncedAt},
        defense_type = #{defenseType},
        defense_problem_id = #{defenseProblemId},
        defense_start_time = #{defenseStartTime},
        silver_streak = #{silverStreak},
        gold_streak = #{goldStreak},
        max_silver_streak = #{maxSilverStreak},
        max_gold_streak = #{maxGoldStreak},
        deleted_at = #{deletedAt}
    WHERE id = #{id}
  </update>

  <update id="delete" parameterType="long">
    UPDATE users SET deleted_at = CURRENT_TIMESTAMP
    WHERE id = #{id}
  </update>

  <select id="selectByStudyId" resultType="User" parameterType="long">
    SELECT * FROM users WHERE study_id = #{studyId} AND deleted_at IS NULL ORDER BY id
  </select>

  <select id="selectUsersForAnonymization" resultType="User" parameterType="java.time.LocalDateTime">
    SELECT * FROM users
    WHERE deleted_at IS NOT NULL
      AND deleted_at &lt; #{threshold}
      AND provider_id IS NOT NULL
  </select>

  <update id="anonymize" parameterType="long">
    UPDATE users
    SET username = 'Unknown User',
        email = CONCAT('deleted_', id, '@deleted.com'),
        provider = NULL,
        provider_id = NULL,
        avatar_url = NULL,
        solvedac_handle = NULL,
        solvedac_tier = NULL,
        solvedac_rating = NULL,
        solvedac_class = NULL,
        solved_count = 0
    WHERE id = #{id}
  </update>

</mapper>

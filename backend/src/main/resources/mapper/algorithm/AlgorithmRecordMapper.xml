<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.dash.algorithm.infrastructure.mapper.AlgorithmRecordMapper">

  <insert id="insert" parameterType="AlgorithmRecord" useGeneratedKeys="true" keyProperty="id">
    INSERT INTO algorithm_records (
      user_id, study_id, problem_number, title, code, language, platform, difficulty,
      runtime_ms, memory_kb, repository_name, file_path, commit_sha, commit_message,
      committed_at, created_at, updated_at, record_type, tag, defense_streak
    ) VALUES (
      #{userId}, #{studyId}, #{problemNumber}, #{title}, #{code}, #{language}, #{platform}, #{difficulty},
      #{runtimeMs}, #{memoryKb}, #{repositoryName}, #{filePath}, #{commitSha}, #{commitMessage},
      #{committedAt}, #{createdAt}, #{updatedAt}, #{recordType}, #{tag}, #{defenseStreak}
    )
  </insert>

  <select id="selectById" resultType="AlgorithmRecord" parameterType="long">
    SELECT * FROM algorithm_records WHERE id = #{id}
  </select>

  <select id="selectAll" resultType="AlgorithmRecord">
    SELECT r.*, r.tag, u.username,
           car.score, car.time_complexity, car.space_complexity, car.complexity_explanation, 
           car.patterns, car.algorithm_intuition, car.pitfalls, car.key_blocks, 
           car.refactor_provided, car.refactor_code, car.refactor_explanation, car.full_response, car.full_response, car.full_response, car.full_response
    FROM algorithm_records r
    LEFT JOIN users u ON r.user_id = u.id
    LEFT JOIN code_analysis_results car ON r.id = car.algorithm_record_id
    ORDER BY r.id DESC
  </select>

  <select id="selectByUserId" resultType="AlgorithmRecord" parameterType="long">
    SELECT r.*, u.username,
           car.score, car.time_complexity, car.space_complexity, car.complexity_explanation, 
           car.patterns, car.algorithm_intuition, car.pitfalls, car.key_blocks, 
           car.refactor_provided, car.refactor_code, car.refactor_explanation, car.full_response, car.full_response, car.full_response, car.full_response
    FROM algorithm_records r
    LEFT JOIN users u ON r.user_id = u.id
    LEFT JOIN code_analysis_results car ON r.id = car.algorithm_record_id
    WHERE r.user_id = #{userId} AND r.record_type = 'USER_SOLUTION'
    ORDER BY r.id DESC
  </select>

  <select id="selectByStudyId" resultType="AlgorithmRecord" parameterType="long">
    SELECT r.*, u.username,
           car.score, car.time_complexity, car.space_complexity, car.complexity_explanation, 
           car.patterns, car.algorithm_intuition, car.pitfalls, car.key_blocks, 
           car.refactor_provided, car.refactor_code, car.refactor_explanation, car.full_response, car.full_response, car.full_response, car.full_response
    FROM algorithm_records r
    LEFT JOIN users u ON r.user_id = u.id
    LEFT JOIN code_analysis_results car ON r.id = car.algorithm_record_id
    WHERE r.study_id = #{studyId} 
    ORDER BY r.id DESC
  </select>

  <update id="update" parameterType="AlgorithmRecord">
    UPDATE algorithm_records
    SET problem_number = #{problemNumber}, title = #{title}, code = #{code}, language = #{language},
        platform = #{platform}, difficulty = #{difficulty}, runtime_ms = #{runtimeMs}, memory_kb = #{memoryKb},
        repository_name = #{repositoryName}, file_path = #{filePath}, commit_sha = #{commitSha},
        commit_message = #{commitMessage}, committed_at = #{committedAt}, updated_at = #{updatedAt},
        defense_streak = #{defenseStreak}, tag = #{tag}
    WHERE id = #{id}
  </update>

  <delete id="delete" parameterType="long">
    DELETE FROM algorithm_records WHERE id = #{id}
  </delete>

  <select id="countsByStudyId" resultType="com.ssafy.dash.algorithm.domain.StudyStats" parameterType="long">
    SELECT
      COALESCE(SUM(CASE WHEN r.difficulty LIKE '%Bronze%' OR (r.difficulty REGEXP '^[1-5]$') THEN 1 ELSE 0 END), 0) as bronze,
      COALESCE(SUM(CASE WHEN r.difficulty LIKE '%Silver%' OR (r.difficulty REGEXP '^([6-9]|10)$') THEN 1 ELSE 0 END), 0) as silver,
      COALESCE(SUM(CASE WHEN r.difficulty LIKE '%Gold%' OR (r.difficulty REGEXP '^(1[1-5])$') THEN 1 ELSE 0 END), 0) as gold,
      COALESCE(SUM(CASE WHEN r.difficulty LIKE '%Platinum%' OR (r.difficulty REGEXP '^(1[6-9]|20)$') THEN 1 ELSE 0 END), 0) as platinum
    FROM algorithm_records r
    INNER JOIN users u ON r.user_id = u.id
    WHERE u.study_id = #{studyId} AND u.deleted_at IS NULL AND r.record_type = 'USER_SOLUTION'
  </select>

  <select id="countSuccessfulSubmissionByUserIdAndProblemNumber" resultType="int">
    SELECT COUNT(*)
    FROM algorithm_records
    WHERE user_id = #{userId}
      AND problem_number = #{problemNumber}
      AND runtime_ms IS NOT NULL
      AND memory_kb IS NOT NULL
  </select>

  <select id="selectSolvedProblemNumbersByUserId" resultType="string" parameterType="long">
    SELECT DISTINCT problem_number
    FROM algorithm_records
    WHERE user_id = #{userId}
      AND runtime_ms IS NOT NULL
      AND memory_kb IS NOT NULL
  </select>


</mapper>
